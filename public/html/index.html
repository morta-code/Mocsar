<html>
	<head>
		<title>Mocsar Game</title>
		<script type='text/javascript' src="/js/jquery-1.9.1.js"></script>
		<script type='text/javascript' src="/js/knockout-2.2.1.debug.js"></script>
		
		<script type='text/javascript' src="/js/socket.io/node_modules/socket.io-client/dist/socket.io.js"></script>

		<!--<script type="text/html" id="templateAdmin">
		/*
			<label for="aiNumber">MI játékosok száma:</label>
			<input type="number" name="aiNumber" id="aiNumber" min="0" max="11">
			<button id="sendAi">SendAdminSettings</button>
			<button id="start">StartGame</button>
		*/
		</script>
	-->

		<script type="text/javascript">
			function viewModel(){
				this.userName  = ko.observable("");
				this.id 	   = ko.observable("");
				this.aiNumbers = ko.observable("0");

				this.players = ko.observableArray([]);

				this.state = ko.observable(0);
			
				var socket = null;

				var nameError = "username is used";
				this.badname = ko.observable(false);

				var isLogin = ko.computed(function(){
					return (this.userName() == "" || this.id() == "") && this.state() == 0;
				}, this);

				var isSettings = ko.computed(function(){
					return (this.userName() != "" || this.id() != "") && this.state() == 1;
				}, this);

				var isAdmin = ko.computed(function(){
					return this.id() == "0";
				}, this);


				var isError = ko.computed(function(){
					return badname();
				}, this);			

				var sendData = function(name, data){
					if(socket==null){
						connectToServer();
						init();
					}
					socket.emit(name, data);
				};

				var sendUserName = function(){
  					sendData('myname', this.userName());	
  				};

  				var sendAi = function(){
  					//sendData('startgame', this.aiNumbers());		
  					sendData('startgame', 10);	
  				}

  				var __newplayer = function (data) {
    				players.removeAll();
					for (var i = 0; i < data.length; i++) {
    					players.push(data[i]);
    				}
  				};

  				var __badname = function(data){
	  				badname(data.state);
	  				if(!data.state){	  					
	  					userName(data.name);
						id(data.id);
						state(state()+1);
					}
  				};

  				var __newround = function(data){
  					console.log(data);
  				};

  				var init = function(){
	  				socket.on('newplayer', __newplayer);
  					socket.on('badname', __badname);
  					socket.on('newround', __newround);
				};

				var connectToServer = function(){
					socket = io.connect('http://localhost');
				};

				var userList = ko.computed(function(){
					var html = "";
					
					for (var i = 0; i < players().length; i++) {
						html += ("<div>" + players()[i].name + "</div>");
					};
					return html;
				});
				
				return {
					userName: userName,
					nameError: nameError,
	 				badname: badname,
					isLogin: isLogin,
					isError: isError,
					isSettings: isSettings,
					isAdmin: isAdmin,
					players: players,
					sendUserName: sendUserName,
					sendAi: sendAi,
					userList: userList
				};
			};
  			
  			$(document).ready(function(){
  				ko.applyBindings(viewModel());
  			});

		</script>
	</head>
	<body>
		<div id="login" data-bind="visible: isLogin">
			<input type="text" name="Nev" id="nev" data-bind="value: userName, valueUpdate: 'afterkeydown'" />
			<div data-bind="text: userName"></div>
			<button name="ok" id="send" data-bind="click: sendUserName, enabled: isLogin">Send</button>
			<span id="error" data-bind="text: nameError, visible: isError"></span>
		</div>

		<div id="settingsArea" data-bind="visible: isSettings">
			<div id="userList" data-bind="html: userList()">
				
			</div>
			<div id="adminArea" data-bind="visible: isAdmin">
				<label for="aiNumber">MI játékosok száma:</label>
				<input type="number" name="aiNumber" id="aiNumber" min="0" max="11" data-bind="value: aiNumbers, valueUpdate: 'afterkeydown'">
				<button id="start" data-bind="enabled: isAdmin, click: sendAi">StartGame</button>
			</div>
		</div>
		<div id="gameArea" style="display:none;"></div>
	
	</body>
</html>